<!-- Estado p√∫blico de la partida -->
@if (publicState(); as st) {
<h2>Partida - Sala {{ st.roomId.substring(0, 6) }}</h2>
<p>Iniciada: {{ st.startedAt | date : "dd/MM/yyyy HH:mm" }}</p>
<p>Mazo: {{ st.deckCount }} cartas</p>
<p>Descarte: {{ st.discardCount }} cartas</p>

@let active = st.players[st.turnIndex];

<h3>Turno</h3>
<p>
  Turno actual:
  <strong>{{ active?.player?.name ?? "‚Äî" }}</strong>
  (l√≠mite {{ st.turnDeadlineTs | date : "HH:mm:ss" }}) ‚Äî quedan
  {{ remainingSeconds() }}s
</p>

<!-- <h3>Jugadores</h3>
<ul>
  @for (p of st.players; track p.player.id) {
  <li>
    <strong>{{ p.player.name }}</strong> - {{ p.handCount }} cartas en mano
    <br />
    √ìrganos en mesa: @if (p.board.length === 0) { ‚Äî } @else {
    <ul>
      @for (card of p.board; track card.id) {
      <li>
        {{ card.kind }} - {{ card.color }} @if (card.kind === 'treatment' &&
        card.subtype) { ({{ card.subtype }}) }
      </li>
      }
    </ul>
    }
  </li>
  }
</ul> -->
<h3>Tablero</h3>
<div class="players">
  @for (p of st.players; track p.player.id) {
  <div class="player">
    <div class="player-header">
      <strong>{{ p.player.name }}</strong>
      <span class="handcount">{{ p.handCount }} en mano</span>
    </div>

    <div class="board-grid">
      @for (color of cardColors; track color) {
      <div class="board-slot">
        @let organ = getOrganByColor(p, color); @if (organ) {
        <div class="card organ {{ organ.color }}">
          <div class="title">{{ organ.color | titlecase }}</div>

          @if (organ.attached.length) {
          <div class="attachments">
            @for (a of organ.attached; track a.id) {
            <span class="chip {{ a.kind }}">{{ a.kind }} - {{ a.color }}</span>
            }
          </div>
          }
        </div>
        } @else {
        <div class="slot-empty {{ color }}">{{ color | titlecase }}</div>
        }
      </div>
      }
    </div>
  </div>
  }
</div>

<button (click)="draw()" [disabled]="!isMyTurn()">Robar carta</button>
<button (click)="endTurn()" [disabled]="!isMyTurn()">Finalizar turno</button>
}

<!-- Errores -->
@if (lastError()) {
<p class="error">‚ö†Ô∏è {{ lastError() }}</p>
}

<!-- Mano privada -->
<h3>Tu mano: {{ hand().length }} cartas</h3>
@if (hand().length) {
<ul>
  @for (card of hand(); track card.id) {
  <li>
    {{ card.kind }} - {{ card.color }} @if (card.kind === 'treatment' &&
    card.subtype) { ({{ card.subtype }}) }
    <button (click)="selectCardToPlay(card)" [disabled]="!isMyTurn()">
      Jugar
    </button>
  </li>
  }
</ul>
} @else {
<p>Sin cartas</p>
}

<!-- üîΩ UI para seleccionar objetivo si hace falta -->
@if (selectedCard && isMyTurn()) {
<div class="target-select">
  <p>
    Has seleccionado:
    <strong>{{ selectedCard.kind }} - {{ selectedCard.color }}</strong>
  </p>

  @if (targetOptions.length) {
  <label>Objetivo:</label>
  <select (change)="onTargetChange($event)">
    <option value="">-- Selecciona --</option>
    @for (opt of targetOptions; track opt.organId) {
    <option [value]="opt.organId + '|' + opt.playerId">
      {{ opt.label }}
    </option>
    }
  </select>
  }

  <button (click)="confirmPlayCard()">Confirmar</button>
  <button (click)="selectedCard = null; selectedTarget = null">Cancelar</button>
</div>
}
