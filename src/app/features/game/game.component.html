<!-- Estado p√∫blico de la partida -->
@if (publicState(); as st) {
<h2>Partida - Sala {{ st.roomId.substring(0, 6) }}</h2>
<p>Iniciada: {{ st.startedAt | date : "dd/MM/yyyy HH:mm" }}</p>
<p>Mazo: {{ st.deckCount }} cartas</p>
<p>Descarte: {{ st.discardCount }} cartas</p>

@let active = st.players[st.turnIndex];

<h3>Turno</h3>
<p>
  Turno actual:
  <strong>{{ active?.player?.name ?? "‚Äî" }}</strong>
  (l√≠mite {{ st.turnDeadlineTs | date : "HH:mm:ss" }}) ‚Äî quedan
  {{ remainingSeconds() }}s
</p>

<h3>Tablero</h3>
<div class="players">
  @for (p of st.players; track p.player.id) {
  <div class="player">
    <div class="player-header">
      <strong>{{ p.player.name }}</strong>
      <span class="handcount">{{ p.handCount }} en mano</span>
    </div>

    <div class="board-grid">
      @for (color of cardColors; track color) {
      <div class="board-slot">
        @let organ = getOrganByColor(p, color); @if (organ) {
        <div class="card organ {{ organ.color }}">
          <div class="title">{{ organ.color | titlecase }}</div>

          @if (organ.attached.length) {
          <div class="attachments">
            @for (a of organ.attached; track a.id) {
            <span class="chip {{ a.kind }}">{{ a.kind }} - {{ a.color }}</span>
            }
          </div>
          }
        </div>
        } @else {
        <div class="slot-empty {{ color }}">{{ color | titlecase }}</div>
        }
      </div>
      }
    </div>
  </div>
  }
</div>

<button (click)="draw()" [disabled]="!isMyTurn()">Robar carta</button>
<button (click)="endTurn()" [disabled]="!isMyTurn()">Finalizar turno</button>
}

<!-- Errores -->
@if (lastError()) {
<p class="error">‚ö†Ô∏è {{ lastError() }}</p>
}

<!-- Mano privada -->
<h3>Tu mano: {{ hand().length }} cartas</h3>
@if (hand().length) {
<ul>
  @for (card of hand(); track card.id) {
  <li>
    {{ card.kind }} - {{ card.color }} @if (card.kind === 'treatment' &&
    card.subtype) { ({{ card.subtype }}) }
    <button (click)="selectCardToPlay(card)" [disabled]="!isMyTurn()">
      Jugar
    </button>
  </li>
  }
</ul>
} @else {
<p>Sin cartas</p>
}

<!-- üîΩ UI para seleccionar objetivo si hace falta -->
@if (selectedCard && isMyTurn()) {
<div class="target-select">
  <p>
    Has seleccionado:
    <strong>
      {{ selectedCard.kind }} - {{ selectedCard.color }} @if (selectedCard.kind
      === CardKind.Treatment && selectedCard.subtype) { ({{
        selectedCard.subtype
      }}) }
    </strong>
  </p>

  <!-- Transplante: dos selects -->
  @if (selectedCard.kind === CardKind.Treatment && selectedCard.subtype ===
  TreatmentSubtype.Transplant) {
  <label>√ìrgano A:</label>
  <select (change)="onTargetChange($event, 'A')">
    <option value="">-- Selecciona --</option>
    @for (opt of targetOptions; track opt.organId) {
    <option [value]="opt.organId + '|' + opt.playerId">{{ opt.label }}</option>
    }
  </select>

  <label>√ìrgano B:</label>
  <select (change)="onTargetChange($event, 'B')">
    <option value="">-- Selecciona --</option>
    @for (opt of targetOptions; track opt.organId) {
    <option [value]="opt.organId + '|' + opt.playerId">{{ opt.label }}</option>
    }
  </select>
  }

  <!-- Contagion: un select por cada virus trasladable -->
  @if (selectedCard.kind === CardKind.Treatment && selectedCard.subtype ===
  TreatmentSubtype.Contagion) {
  <h4>Asigna cada virus a un √≥rgano libre de otro jugador</h4>

  @for (assignment of contagionAssignments; let i = $index; track i) {
  <div class="contagion-assignment">
    <label>Virus desde √≥rgano {{ assignment.fromOrganId }} ‚Üí</label>
    <select (change)="onContagionTargetChange($event, i)">
      <option value="">-- Selecciona destino --</option>
      @for (p of publicState()?.players; track p.player.id) { @for (o of
      p.board; track o.id) {
      <!-- Mostrar solo √≥rganos libres -->
      @if (!o.attached.length) {
      <option [value]="o.id + '|' + p.player.id">
        {{ p.player.name }} ¬∑ {{ o.color }}
      </option>
      } } }
    </select>
  </div>
  } }

  <!-- Otros casos (Virus, Medicina, Ladr√≥n, Error M√©dico) -->
  @if (targetOptions.length && !(selectedCard.kind === CardKind.Treatment &&
  (selectedCard.subtype === TreatmentSubtype.Transplant || selectedCard.subtype
  === TreatmentSubtype.Contagion))) {
  <label>Objetivo:</label>
  <select (change)="onTargetChange($event)">
    <option value="">-- Selecciona --</option>
    @for (opt of targetOptions; track opt.organId) {
    <option [value]="opt.organId + '|' + opt.playerId">{{ opt.label }}</option>
    }
  </select>
  }

  <button (click)="confirmPlayCard()">Confirmar</button>
  <button
    (click)="
      selectedCard = null; selectedTarget = null; contagionAssignments = []
    "
  >
    Cancelar
  </button>
</div>
}
